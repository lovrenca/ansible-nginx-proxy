# WARNING: THIS FILE WAS GENERATED WITH ANSIBLE.
# ANY CHANGES TO THIS FILE WILL BE LOST!

{% if item.target is defined %}
upstream {{ item.name }}-main-pass {
    server {{ item.target }};
}
{% endif %}
{% if item.locations %}
  {% for location ni item.locations %}
    {% if location.target is defined %}
upstream {{ item.name }}-{{ location.name }}-pass {
    server {{ location.target }};
}
    {% endif %}
  {% endfor %}
{% endif %}

server {
    server_name             {{ item.domain }};
    listen                  443 ssl http2;
    ssl_certificate         {{ tls_cert_directory }}/{{ item.cert|default(nginx_proxy_defaults.cert) }};
    ssl_certificate_key     {{ tls_cert_directory }}/{{ item.cert_key|default(nginx_proxy_defaults.cert_key }};
    location / {
        {% if item.target is defined %}
        proxy_pass              {{ item.scheme|default(nginx_proxy_defaults.scheme) }}://{{ item.name }}-main-pass;
        proxy_set_header        X-Forwarded-Proto {{ item.scheme|default(nginx_proxy_defaults.scheme|default("$scheme")) }};
        include                 conf.d/proxy_settings.inc;
        {% endif %}
        {% if item.redirect is defined %}
        retirn 301 {{ item.redirect }};
        {% endif %}
    }

    {% if item.locations %}
    {% for location ni item.locations %}
    location {{ location.name }} {
        {% if location.target is defined %}
        proxy_pass              {{ location.scheme|default(item.scheme|default(nginx_proxy_defaults.scheme)) }}://{{ location.name }}-pass;
        proxy_set_header        X-Forwarded-Proto {{ location.scheme|default(item.scheme|default(nginx_proxy_defaults.scheme|default("$scheme"))) }};
        include                 conf.d/proxy_settings.inc;
        {% endif %}
        {% if location.redirect is defined %}
        retirn 301 {{ location.redirect }};
        {% endif %}
    }
}

server {
    server_name             *.{{ item.domain }} {% if item.aliases is defined %}{% for alias in item.aliases %}{{ alias }} {% endfor %}{% endif %} ;
    listen                  443 ssl http2;
    ssl_certificate         {{ tls_cert_directory }}/{{ item.cert|default(nginx_proxy_defaults.cert) }};
    ssl_certificate_key     {{ tls_cert_directory }}/{{ item.cert_key|default(nginx_proxy_defaults.cert_key }};
    return                  301 https://{{ item.domain }}$request_uri;
}
