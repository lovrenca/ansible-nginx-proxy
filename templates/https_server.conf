# WARNING: THIS FILE WAS GENERATED WITH ANSIBLE.
# ANY CHANGES TO THIS FILE WILL BE LOST!

server {
    server_name             {{ item.domain }};
    listen                  443 ssl http2;
    ssl_certificate         {{ item.cert|default(nginx_proxy_defaults.cert) }};
    ssl_certificate_key     {{ item.cert_key|default(nginx_proxy_defaults.cert_key) }};
    access_log              /var/log/nginx/{{ item.name }}-access.log;
    error_log               /var/log/nginx/{{ item.name }}-error.log;
    access_log              syslog:server=unix:/dev/log,facility=local7,tag=nginx_{{ item.name }};
    error_log               syslog:server=unix:/dev/log,facility=local7,tag=nginx_{{ item.name }};

{# INCLUDES #}
{% if item.server_includes is defined %}
{% for include in item.server_includes|default(omit) %}
    include conf.d/{{ include }};
{% endfor %}
{% endif %}

{# DEFAULT LOCATION #}
    location / {
{% if item.location_includes is defined %}
{% for include in item.location_includes|default(omit) %}
        include conf.d/{{ include }};
{% endfor %}
{% endif %}
{# TARGET #}
{% if item.target is defined %}
        proxy_pass              {{ item.scheme|default(nginx_proxy_defaults.scheme) }}://{{ item.target }};
        proxy_set_header        X-Forwarded-Proto {{ item.scheme|default(nginx_proxy_defaults.scheme)|default("$scheme") }};
        include                 fastcgi_params;
        include                 conf.d/proxy_settings.inc;
{% endif %}
{% if item.redirect is defined %}
        return 301 {{ item.redirect }};
{% endif %}
    }
{# LOCATIONS #}
{% if item.locations is defined %}
{% for location in item.locations|default(omit) %}
    location /{{ location.name }} {
{% if location.includes is defined %}
{% for include in location.includes|default(omit) %}
        include conf.d/{{ include }};
{% endfor %}
{% endif %}
{% if location.target is defined %}
        proxy_pass              {{ location.scheme|default(item.scheme)|default(nginx_proxy_defaults.scheme) }}://{{ location.target }};
        proxy_set_header        X-Forwarded-Proto {{ location.scheme|default(item.scheme)|default(nginx_proxy_defaults.scheme)|default("$scheme") }};
        include                 conf.d/proxy_settings.inc;
{% endif %}
{% if location.redirect is defined %}
        return 301 {{ location.redirect }};
{% endif %}
    }
{% endfor %}
{% endif %}
}

server {
    server_name             *.{{ item.domain }} {% if item.aliases is defined %}{% for alias in item.aliases %}{{ alias }} {% endfor %}{% endif %} ;
    listen                  443 ssl http2;
    ssl_certificate         {{ item.cert|default(nginx_proxy_defaults.cert) }};
    ssl_certificate_key     {{ item.cert_key|default(nginx_proxy_defaults.cert_key) }};
    return                  301 https://{{ item.domain }}$request_uri;
}

server {
    server_name             .{{ item.domain }} {% if item.aliases is defined %}{% for alias in item.aliases %}.{{ alias }} {% endfor %}{% endif %} ;
    listen                  80;
    location / {
      return                  301 https://{{ item.domain }}$request_uri;
    }
{# LETSENCRYPT #}
{% if item.letsencrypt is defined  %}
{% if item.letsencrypt %}
    location ~ /.well-known {
        allow       all;
        root        /opt/letsencrypt/challenge;
        try_files   $uri $uri/ {% if item.target is defined %}
          @{{ item.name }}
          {% endif %}
          =404;
        access_log  /var/log/nginx/{{ item.name }}-le-access.log;
        error_log   /var/log/nginx/{{ item.name }}-le-error.log;
    }
{# LOCATION #}
{% if item.target is defined %}
    location @{{ item.name }} {
        proxy_pass              http://{{ item.target }};
        proxy_set_header        X-Forwarded-Proto http;
        include                 conf.d/proxy_settings.inc;
    }
{% endif %}
{% endif %}
{% endif %}
}
